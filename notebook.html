<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‚˜ì˜ ë‹¨ì–´ì¥ - JP Tutor</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Noto Sans JP', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 800px; margin: 0 auto; }
.header { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.header h1 { color: #667eea; font-size: 1.8em; margin-bottom: 10px; }
.nav-links { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
.nav-links a { padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9em; }
.nav-links a:hover { background: #5a6fd6; }
.date-selector { background: white; border-radius: 15px; padding: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; justify-content: center; }
.date-selector input { padding: 10px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em; }
.date-selector button { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; }
.stats { background: white; border-radius: 15px; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-around; text-align: center; }
.stat-item { }
.stat-num { font-size: 1.5em; color: #667eea; font-weight: bold; }
.stat-label { font-size: 0.8em; color: #666; }
.cards-container { display: flex; flex-direction: column; gap: 15px; }
.card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.card-type { font-size: 0.75em; padding: 4px 10px; border-radius: 10px; color: white; }
.card-type.vocab { background: #4CAF50; }
.card-type.kanji { background: #FF9800; }
.card-type.grammar { background: #2196F3; }
.card-type.conv { background: #9C27B0; }
.card-delete { background: #ff4757; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em; }
.card-main { font-size: 1.8em; color: #333; margin-bottom: 5px; }
.card-reading { font-size: 1em; color: #667eea; margin-bottom: 5px; }
.card-meaning { font-size: 1em; color: #666; margin-bottom: 10px; }
.card-example { background: #f8f9fa; padding: 10px; border-radius: 10px; margin-bottom: 15px; }
.card-example-jp { font-size: 1.1em; color: #333; }
.card-example-kr { font-size: 0.9em; color: #666; }
.speak-btn { background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
.practice-area { border-top: 2px dashed #ddd; padding-top: 15px; margin-top: 15px; }
.practice-title { font-size: 0.9em; color: #666; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
.practice-clear { background: #ff6b6b; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em; }
.practice-notebook { display: flex; flex-direction: column; gap: 5px; }
.practice-line { width: 100%; height: 40px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; position: relative; }
.practice-line canvas { width: 100%; height: 100%; border-radius: 5px; cursor: crosshair; touch-action: none; }
.practice-line .guide-text { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 1.2em; color: #ddd; pointer-events: none; z-index: 0; font-family: 'Noto Sans JP', sans-serif; }
.quiz-section { background: white; border-radius: 15px; padding: 20px; margin-top: 20px; text-align: center; }
.quiz-btn { padding: 15px 40px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 25px; font-size: 1.1em; cursor: pointer; }
.quiz-btn:hover { transform: scale(1.05); }
.empty-state { background: white; border-radius: 15px; padding: 40px; text-align: center; color: #666; }
.empty-state h3 { margin-bottom: 10px; color: #333; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
.modal.show { display: flex; }
.modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; }
.modal h3 { margin-bottom: 20px; color: #333; }
.quiz-question { font-size: 1.5em; margin-bottom: 20px; }
.quiz-options { display: flex; flex-direction: column; gap: 10px; }
.quiz-option { padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; text-align: left; }
.quiz-option:hover { border-color: #667eea; }
.quiz-option.correct { background: #4CAF50; color: white; border-color: #4CAF50; }
.quiz-option.wrong { background: #f44336; color: white; border-color: #f44336; }
.quiz-result { text-align: center; padding: 20px; }
.quiz-score { font-size: 2em; color: #667eea; }
.modal-close { margin-top: 20px; padding: 10px 30px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; }
/* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
.bottom-nav-inner { display: flex; justify-content: space-around; max-width: 500px; margin: 0 auto; padding: 0.5rem 0; }
.nav-btn { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; padding: 0.5rem; border: none; background: none; color: #9ca3af; font-size: 0.7rem; cursor: pointer; text-decoration: none; min-width: 60px; }
.nav-btn.active { color: #667eea; }
.nav-btn span:first-child { font-size: 1.25rem; }
/* ë¡œê·¸ì¸ */
.login-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; background: #667eea; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.8rem; color: white; }
.user-info { display: flex; align-items: center; gap: 0.4rem; background: none; border: none; cursor: pointer; }
.user-avatar { width: 1.75rem; height: 1.75rem; border-radius: 50%; }
.user-name { font-size: 0.8rem; color: #374151; }
.sync-icon { font-size: 0.75rem; color: #667eea; }
.dropdown { position: relative; }
.dropdown-menu { position: absolute; top: 100%; right: 0; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 140px; z-index: 200; display: none; }
.dropdown-menu.show { display: block; }
.dropdown-item { padding: 0.6rem 1rem; cursor: pointer; font-size: 0.85rem; color: #374151; }
.dropdown-item:hover { background: #f3f4f6; }
</style>
</head>
<body>
<div class="container" style="padding-bottom: 70px;">
  <div class="header" style="display:flex;flex-direction:column;gap:10px;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h1>ğŸ“– ë‚˜ì˜ ë‹¨ì–´ì¥</h1>
      <div style="display:flex;align-items:center;gap:10px;">
        <div id="loginArea"></div>
        <button onclick="showSettings()" title="ì„¤ì •" style="background:none;border:none;font-size:1.2rem;cursor:pointer;">âš™ï¸</button>
      </div>
    </div>
    <div id="xpHeader" style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:10px;color:white;font-size:0.85rem;"></div>
  </div>
  
  <div class="date-selector">
    <label>ë‚ ì§œ ì„ íƒ:</label>
    <input type="date" id="dateInput">
    <button onclick="loadDate()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button onclick="loadAllDates()">ì „ì²´ ë³´ê¸°</button>
    <button onclick="clearAllNotebook()" style="background:#ef4444;color:white;">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
    <button id="cloudSaveBtn" onclick="window.saveToCloud()" style="display:none;background:#4CAF50;">â˜ï¸ ì˜¤ëŠ˜ í•™ìŠµ ì €ì¥</button>
  </div>
  
  <div class="stats">
    <div class="stat-item"><div class="stat-num" id="totalCount">0</div><div class="stat-label">ì´ ë‹¨ì–´</div></div>
    <div class="stat-item"><div class="stat-num" id="todayCount">0</div><div class="stat-label">ì˜¤ëŠ˜ ì¶”ê°€</div></div>
    <div class="stat-item"><div class="stat-num" id="practicedCount">0</div><div class="stat-label">ì—°ìŠµ ì™„ë£Œ</div></div>
  </div>
  
  <div class="cards-container" id="cardsContainer"></div>
  
  <div class="quiz-section" id="quizSection" style="display:none;">
    <h3>ğŸ“ ë‹¨ì–´ì¥ í€´ì¦ˆ</h3>
    <p style="color:#666;margin-bottom:15px;">ì €ì¥í•œ ë‹¨ì–´ë¡œ ì‹¤ë ¥ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”!</p>
    <button class="quiz-btn" onclick="startQuiz()">ğŸ¯ í€´ì¦ˆ ì‹œì‘</button>
  </div>
</div>

<div class="modal" id="quizModal">
  <div class="modal-content" id="quizContent"></div>
</div>

<script src="romaji.js"></script>
<script src="jlpt-xp.js"></script>
<script src="jlpt-streak.js"></script>
<script>
// í”„ë¡œí•„ ì‹œìŠ¤í…œ
let currentProfile = localStorage.getItem('currentProfile') || 'ê²ŒìŠ¤íŠ¸';
function getStorageKey(key) { return 'notebook_' + currentProfile + '_' + key; }

// ë‚ ì§œ í¬ë§·
function getToday() {
  const d = new Date();
  return d.toISOString().split('T')[0];
}

// ë‹¨ì–´ì¥ ë°ì´í„° ë¡œë“œ
function getNotebook() {
  return JSON.parse(localStorage.getItem(getStorageKey('data')) || '{}');
}

function saveNotebook(data) {
  localStorage.setItem(getStorageKey('data'), JSON.stringify(data));
}

// ì´ˆê¸°í™”
document.getElementById('dateInput').value = getToday();
let currentViewDate = getToday();
let viewAll = false;

function loadDate() {
  currentViewDate = document.getElementById('dateInput').value;
  viewAll = false;
  renderCards();
}

function loadAllDates() {
  viewAll = true;
  renderCards();
}

// TTS
function speak(text, rate = 0.8) {
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'ja-JP';
  u.rate = rate;
  speechSynthesis.speak(u);
}

// ì¹´ë“œ ì‚­ì œ
function deleteCard(date, index) {
  if (!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
  const nb = getNotebook();
  if (nb[date]) {
    nb[date].splice(index, 1);
    if (nb[date].length === 0) delete nb[date];
    saveNotebook(nb);
    renderCards();
  }
}

function clearAllNotebook() {
  if (!confirm('âš ï¸ ë‹¨ì–´ì¥ì˜ ëª¨ë“  ë‹¨ì–´ë¥¼ ì‚­ì œí• ê¹Œìš”?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) return;
  saveNotebook({});
  renderCards();
  alert('ë‹¨ì–´ì¥ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

// ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸° ê´€ë ¨
let activeCanvases = [];

function initCanvases() {
  activeCanvases = [];
  document.querySelectorAll('.practice-line canvas').forEach(canvas => {
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    
    const ctx = canvas.getContext('2d');
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    let drawing = false;
    let lastX = 0, lastY = 0;
    
    const getPos = (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      return { x, y };
    };
    
    const startDraw = (e) => {
      e.preventDefault();
      drawing = true;
      const pos = getPos(e);
      lastX = pos.x;
      lastY = pos.y;
    };
    
    const draw = (e) => {
      if (!drawing) return;
      e.preventDefault();
      const pos = getPos(e);
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      lastX = pos.x;
      lastY = pos.y;
    };
    
    const endDraw = () => { drawing = false; };
    
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);
    canvas.addEventListener('touchstart', startDraw, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', endDraw);
    
    activeCanvases.push({ canvas, ctx });
  });
}

function clearAllCanvases(cardIdx) {
  document.querySelectorAll(`#notebook_${cardIdx} canvas`).forEach(canvas => {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });
}

// ì¹´ë“œ ë Œë”ë§
function renderCards() {
  const nb = getNotebook();
  const container = document.getElementById('cardsContainer');
  const today = getToday();
  
  let cards = [];
  let todayCards = [];
  
  if (viewAll) {
    // ì „ì²´ ë‚ ì§œ
    Object.keys(nb).sort().reverse().forEach(date => {
      nb[date].forEach((card, idx) => {
        cards.push({...card, date, idx});
        if (date === today) todayCards.push(card);
      });
    });
  } else {
    // íŠ¹ì • ë‚ ì§œ
    if (nb[currentViewDate]) {
      nb[currentViewDate].forEach((card, idx) => {
        cards.push({...card, date: currentViewDate, idx});
      });
    }
    if (currentViewDate === today) todayCards = cards;
  }
  
  // í†µê³„
  let total = 0;
  Object.values(nb).forEach(arr => total += arr.length);
  document.getElementById('totalCount').textContent = total;
  document.getElementById('todayCount').textContent = nb[today]?.length || 0;
  
  // í€´ì¦ˆ ì„¹ì…˜ - í˜„ì¬ ë³´ëŠ” ì¹´ë“œ 3ê°œ ì´ìƒì´ë©´ í‘œì‹œ
  document.getElementById('quizSection').style.display = cards.length >= 3 ? 'block' : 'none';
  
  if (cards.length === 0) {
    container.innerHTML = '<div class="empty-state"><h3>ğŸ“ ì•„ì§ ë‹¨ì–´ê°€ ì—†ì–´ìš”</h3><p>JLPTë‚˜ íšŒí™” í˜ì´ì§€ì—ì„œ ì¹´ë“œë¥¼ ë”ë¸”í´ë¦­í•´ì„œ ì¶”ê°€í•´ë³´ì„¸ìš”!</p></div>';
    return;
  }
  
  container.innerHTML = cards.map((card, i) => renderCard(card, i)).join('');
  
  // ìº”ë²„ìŠ¤ ì´ˆê¸°í™” (DOM ì—…ë°ì´íŠ¸ í›„)
  setTimeout(initCanvases, 100);
}

function renderCard(card, i) {
  const typeLabel = {vocab:'ì–´íœ˜', kanji:'í•œì', grammar:'ë¬¸ë²•', conv:'íšŒí™”'}[card.type] || 'ê¸°íƒ€';
  const typeClass = card.type || 'vocab';
  
  // ì—°ìŠµí•  í…ìŠ¤íŠ¸ (ì „ì²´)
  const practiceText = card.kanji || card.jp || card.pattern || card.main || '';
  
  let html = `<div class="card">
    <div class="card-header">
      <span class="card-type ${typeClass}">${typeLabel}</span>
      <div>
        <span style="color:#999;font-size:0.8em;">${card.date}</span>
        <button class="card-delete" onclick="deleteCard('${card.date}', ${card.idx})">ì‚­ì œ</button>
      </div>
    </div>`;
  
  // íƒ€ì…ë³„ ë‚´ìš©
  if (card.type === 'kanji') {
    html += `<div class="card-main">${card.kanji} <button class="speak-btn" onclick="speak('${card.reading}')">ğŸ”Š</button></div>
      <div class="card-reading">${card.onyomi || ''} (${toRomaji(card.onyomi || '')}) / ${card.kunyomi || ''} (${toRomaji(card.kunyomi || '')})</div>
      <div class="card-meaning">${card.meaning}</div>`;
    if (card.example) {
      html += `<div class="card-example">
        <div class="card-example-jp">${card.example} <span style="color:#888;font-size:0.8em;">(${toRomaji(card.example)})</span> <button class="speak-btn" onclick="speak('${card.example}')">ğŸ”Š</button></div>
      </div>`;
    }
  } else if (card.type === 'grammar') {
    html += `<div class="card-main">${card.pattern} <span style="color:#888;font-size:0.75em;">(${toRomaji(card.pattern)})</span> <button class="speak-btn" onclick="speak('${card.pattern}')">ğŸ”Š</button></div>
      <div class="card-meaning">${card.meaning}</div>
      <div class="card-reading">${card.desc || ''}</div>`;
    if (card.examples?.length) {
      html += card.examples.map(ex => `<div class="card-example">
        <div class="card-example-jp">${ex.jp} <span style="color:#888;font-size:0.8em;">(${toRomaji(ex.jp)})</span> <button class="speak-btn" onclick="speak('${ex.jp}')">ğŸ”Š</button></div>
        <div class="card-example-kr">${ex.kr}</div>
      </div>`).join('');
    }
  } else {
    // vocab, conv
    const mainText = card.jp || card.main;
    html += `<div class="card-main">${mainText} <span style="color:#888;font-size:0.75em;">(${toRomaji(mainText)})</span> <button class="speak-btn" onclick="speak('${mainText}')">ğŸ”Š</button></div>`;
    if (card.reading) html += `<div class="card-reading">${card.reading} (${toRomaji(card.reading)})</div>`;
    html += `<div class="card-meaning">${card.kr || card.meaning}</div>`;
  }
  
  // ë”°ë¼ì“°ê¸° ì˜ì—­ (ë…¸íŠ¸ í˜•ì‹)
  html += `<div class="practice-area">
    <div class="practice-title">
      <span>âœï¸ ë”°ë¼ì“°ê¸° ì—°ìŠµ (5íšŒ)</span>
      <button class="practice-clear" onclick="clearAllCanvases(${i})">ğŸ—‘ï¸ ì§€ìš°ê¸°</button>
    </div>
    <div class="practice-notebook" id="notebook_${i}">
      ${[0,1,2,3,4].map(n => `<div class="practice-line">
        <span class="guide-text">${practiceText}</span>
        <canvas id="canvas_${i}_${n}" data-card="${i}" data-line="${n}"></canvas>
      </div>`).join('')}
    </div>
  </div>`;
  
  html += '</div>';
  return html;
}

// í€´ì¦ˆ
let quizData = [];
let quizIndex = 0;
let quizScore = 0;

function startQuiz() {
  const nb = getNotebook();
  
  // í˜„ì¬ ë³´ê³  ìˆëŠ” ì¹´ë“œ ìˆ˜ì§‘
  let quizCards = [];
  if (viewAll) {
    Object.values(nb).forEach(arr => quizCards.push(...arr));
  } else {
    quizCards = nb[currentViewDate] || [];
  }
  
  if (quizCards.length < 3) {
    alert('í€´ì¦ˆë¥¼ í•˜ë ¤ë©´ ìµœì†Œ 3ê°œ ì´ìƒì˜ ë‹¨ì–´ê°€ í•„ìš”í•´ìš”!');
    return;
  }
  
  // ì…”í”Œ ë° ë‹¨ì–´ìˆ˜ x 2ë°° ë¬¸ì œ ìƒì„±
  const questionCount = quizCards.length * 2;
  const shuffled = shuffle([...quizCards]);
  quizData = [];
  for (let i = 0; i < questionCount; i++) {
    quizData.push(shuffled[i % shuffled.length]);
  }
  quizIndex = 0;
  quizScore = 0;
  
  document.getElementById('quizModal').classList.add('show');
  showQuizQuestion();
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function showQuizQuestion() {
  const content = document.getElementById('quizContent');
  
  if (quizIndex >= quizData.length) {
    // ê²°ê³¼ (XP ì—†ìŒ - ìˆœìˆ˜ ë³µìŠµìš©)
    const perfect = quizScore === quizData.length;
    
    content.innerHTML = `<div class="quiz-result">
      <h3>í€´ì¦ˆ ì™„ë£Œ!</h3>
      <div class="quiz-score">${quizScore} / ${quizData.length}</div>
      <p>${perfect ? 'ğŸ‰ ì™„ë²½í•´ìš”!' : quizScore >= quizData.length/2 ? 'ğŸ‘ ì˜í–ˆì–´ìš”!' : 'ğŸ’ª ë‹¤ì‹œ ë³µìŠµí•´ë´ìš”!'}</p>
      <button class="modal-close" onclick="closeQuiz()">ë‹«ê¸°</button>
    </div>`;
    return;
  }
  
  const q = quizData[quizIndex];
  const nb = getNotebook();
  const allCards = [];
  Object.values(nb).forEach(arr => allCards.push(...arr));
  
  // 3ê°€ì§€ ë¬¸ì œ ìœ í˜• ëœë¤
  let quizType = Math.floor(Math.random() * 3);
  const jpText = q.jp || q.kanji || q.pattern || q.main;
  const krText = q.kr || q.meaning;
  const isKanji = q.kanji && q.onyomi && q.kunyomi;
  
  let questionLabel, questionDisplay, correct, wrongPool;
  
  if (quizType === 0) {
    // Type 1: ì¼ë³¸ì–´ â†’ ëœ»
    questionLabel = 'ì´ ë‹¨ì–´ì˜ ëœ»ì€?';
    questionDisplay = jpText;
    correct = krText;
    wrongPool = allCards.filter(c => (c.kr || c.meaning) !== krText).map(c => c.kr || c.meaning);
  } else if (quizType === 1) {
    // Type 2: ëœ» â†’ ì¼ë³¸ì–´
    questionLabel = 'ì´ ëœ»ì˜ ì¼ë³¸ì–´ëŠ”?';
    questionDisplay = krText;
    correct = jpText;
    wrongPool = allCards.filter(c => (c.jp || c.kanji || c.pattern || c.main) !== jpText).map(c => c.jp || c.kanji || c.pattern || c.main);
  } else if (isKanji) {
    // Type 3: í•œì â†’ ìŒë…/í›ˆë… (ë¡œë§ˆì ë³‘ê¸°)
    questionLabel = 'ì´ í•œìì˜ ì½ëŠ” ë²•ì€?';
    questionDisplay = q.kanji;
    correct = `${q.onyomi} (${toRomaji(q.onyomi)}) / ${q.kunyomi} (${toRomaji(q.kunyomi)})`;
    const kanjiCards = allCards.filter(c => c.kanji && c.onyomi && c.kunyomi && c.kanji !== q.kanji);
    wrongPool = kanjiCards.map(c => `${c.onyomi} (${toRomaji(c.onyomi)}) / ${c.kunyomi} (${toRomaji(c.kunyomi)})`);
  } else if (toRomaji(jpText) !== jpText) {
    // Type 3: ì¼ë³¸ì–´ â†’ ë°œìŒ (íˆë¼ê°€ë‚˜/ì¹´íƒ€ì¹´ë‚˜)
    questionLabel = 'ì´ ë‹¨ì–´ì˜ ë°œìŒì€?';
    questionDisplay = jpText;
    correct = `${jpText} (${toRomaji(jpText)})`;
    wrongPool = allCards.filter(c => {
      const jp = c.jp || c.kanji || c.pattern || c.main;
      return jp !== jpText && toRomaji(jp) !== jp;
    }).map(c => {
      const jp = c.jp || c.kanji || c.pattern || c.main;
      return `${jp} (${toRomaji(jp)})`;
    });
  } else {
    // ë°œìŒ ë¬¸ì œ ë¶ˆê°€ â†’ ëœ» ë¬¸ì œë¡œ ëŒ€ì²´
    questionLabel = 'ì´ ë‹¨ì–´ì˜ ëœ»ì€?';
    questionDisplay = jpText;
    correct = krText;
    wrongPool = allCards.filter(c => (c.kr || c.meaning) !== krText).map(c => c.kr || c.meaning);
  }
  
  // ì˜¤ë‹µ ìƒì„±
  let wrongs = shuffle([...new Set(wrongPool)]).slice(0, 3);
  
  // ë³´ê¸° ë¶€ì¡±í•˜ë©´ ëœ» ë¬¸ì œë¡œ ë³€ê²½
  if (wrongs.length < 2) {
    questionLabel = 'ì´ ë‹¨ì–´ì˜ ëœ»ì€?';
    questionDisplay = jpText;
    correct = krText;
    wrongs = shuffle([...new Set(allCards.filter(c => (c.kr || c.meaning) !== krText).map(c => c.kr || c.meaning))]).slice(0, 3);
  }
  
  const options = shuffle([correct, ...wrongs]);
  
  // í˜„ì¬ ë¬¸ì œ ì •ë‹µ ì €ì¥
  quizData[quizIndex].currentCorrect = correct;
  
  content.innerHTML = `
    <h3>ë¬¸ì œ ${quizIndex + 1} / ${quizData.length}</h3>
    <div style="font-size:0.8rem;color:#888;margin-bottom:0.5rem;">${questionLabel}</div>
    <div class="quiz-question">${questionDisplay}</div>
    <div class="quiz-options">
      ${options.map((opt, i) => `<div class="quiz-option" onclick="selectAnswer(this, '${opt.replace(/'/g, "\\'")}', '${correct.replace(/'/g, "\\'")}')">${opt}</div>`).join('')}
    </div>
  `;
}

function selectAnswer(el, selected, correct) {
  const options = document.querySelectorAll('.quiz-option');
  options.forEach(o => o.style.pointerEvents = 'none');
  
  if (selected === correct) {
    el.classList.add('correct');
    quizScore++;
  } else {
    el.classList.add('wrong');
    options.forEach(o => {
      if (o.textContent === correct) o.classList.add('correct');
    });
  }
  
  setTimeout(() => {
    quizIndex++;
    showQuizQuestion();
  }, 1000);
}

function closeQuiz() {
  document.getElementById('quizModal').classList.remove('show');
}

// ==================== XP ì‹œìŠ¤í…œ UI ====================
function updateXpHeader() {
  const header = document.getElementById('xpHeader');
  if (!header) return;
  
  // N5, N4 ì¤‘ ë” ë†’ì€ ë ˆë²¨ë¡œ í‘œì‹œ (ë˜ëŠ” ë§ˆì§€ë§‰ í•™ìŠµí•œ ë ˆë²¨)
  const lastLevel = localStorage.getItem('lastStudyLevel') || 'n5';
  const xpData = window.loadXpData ? window.loadXpData(lastLevel) : { xp: 0, level: 1 };
  const rank = window.getRank ? window.getRank(xpData.level) : { icon: 'ğŸŒ±', name: 'è¦‹ç¿’ã„' };
  const goalInfo = window.getDailyGoalInfo ? window.getDailyGoalInfo() : { todayCount: 0, count: 20, streak: 0 };
  
  header.innerHTML = `
    <button onclick="showRankInfo()" style="background:rgba(255,255,255,0.2);border:none;padding:4px 10px;border-radius:15px;color:white;font-size:0.8rem;cursor:pointer;">
      ${rank.icon} Lv.${xpData.level}
    </button>
    <span>ğŸ”¥ ${goalInfo.streak}ì¼ ìŠ¤íŠ¸ë¦­</span>
    <span>ğŸ“Š ${goalInfo.todayCount}/${goalInfo.count}</span>
  `;
}

function showRankInfo() {
  try {
    const lastLevel = localStorage.getItem('lastStudyLevel') || 'n5';
    const xpData = window.loadXpData ? window.loadXpData(lastLevel) : { xp: 0, level: 1 };
    const rank = window.getRank ? window.getRank(xpData.level) : { icon: 'ğŸŒ±', name: 'è¦‹ç¿’ã„' };
    const nextXp = window.getXpToNextLevel ? window.getXpToNextLevel(xpData) : 100;
    const progress = window.getLevelProgress ? window.getLevelProgress(xpData) : 0;
    const ranks = window.RANKS || [
      { name: 'è¦‹ç¿’ã„', icon: 'ğŸŒ±', minLv: 1, maxLv: 5 },
      { name: 'åˆå¿ƒè€…', icon: 'ğŸŒ¿', minLv: 6, maxLv: 10 },
      { name: 'ä¸­ç´šè€…', icon: 'ğŸŒ³', minLv: 11, maxLv: 15 },
      { name: 'ä¸Šç´šè€…', icon: 'ğŸ”¥', minLv: 16, maxLv: 20 },
      { name: 'é”äºº', icon: 'â­', minLv: 21, maxLv: 25 },
      { name: 'åäºº', icon: 'ğŸ‘‘', minLv: 26, maxLv: 30 }
    ];
    
    const ranksHtml = ranks.map(r => {
      const isCurrent = xpData.level >= r.minLv && xpData.level <= r.maxLv;
      return `<div style="display:flex;justify-content:space-between;padding:0.5rem;${isCurrent?'background:#e0e7ff;border-radius:0.5rem;font-weight:bold;':''}">
        <span>${r.icon} ${r.name}</span>
        <span style="color:#888;">Lv.${r.minLv}~${r.maxLv}</span>
      </div>`;
    }).join('');
    
    showXpPopup(`
      <div style="text-align:center;margin-bottom:1rem;">
        <div style="font-size:3rem;">${rank.icon}</div>
        <div style="font-size:1.5rem;font-weight:bold;">${rank.name}</div>
        <div style="color:#888;">Lv.${xpData.level} | ${xpData.xp} XP</div>
      </div>
      <div style="background:#f3f4f6;border-radius:0.5rem;height:8px;margin-bottom:0.5rem;">
        <div style="background:#667eea;height:100%;border-radius:0.5rem;width:${progress}%;"></div>
      </div>
      <div style="text-align:center;font-size:0.8rem;color:#888;margin-bottom:1rem;">
        ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ ${nextXp} XP
      </div>
      <div style="border-top:1px solid #e5e7eb;padding-top:1rem;">
        <div style="font-weight:bold;margin-bottom:0.5rem;">ğŸ† ê³„ê¸‰í‘œ</div>
        ${ranksHtml}
      </div>
    `);
  } catch(e) {
    console.error('showRankInfo error:', e);
  }
}

function showSettings() {
  try {
    const goalInfo = window.getDailyGoalInfo ? window.getDailyGoalInfo() : { id: 'normal', todayCount: 0, count: 20, streak: 0 };
    const goals = window.DAILY_GOALS || [
      { id: 'easy', name: 'ê°€ë³ê²Œ', count: 10 },
      { id: 'normal', name: 'ë³´í†µ', count: 20 },
      { id: 'hard', name: 'ì—´ì‹¬íˆ', count: 30 },
      { id: 'extreme', name: 'ë¹¡ì„¸ê²Œ', count: 50 }
    ];
    
    const goalsHtml = goals.map(g => `
      <label style="display:flex;align-items:center;padding:0.5rem;cursor:pointer;${goalInfo.id === g.id ? 'background:#e0e7ff;border-radius:0.5rem;' : ''}">
        <input type="radio" name="dailyGoal" value="${g.id}" ${goalInfo.id === g.id ? 'checked' : ''} onchange="changeDailyGoal('${g.id}')" style="margin-right:0.5rem;">
        <span>${g.name}</span>
        <span style="margin-left:auto;color:#888;">${g.count}ê°œ</span>
      </label>
    `).join('');
    
    showXpPopup(`
      <div style="font-weight:bold;font-size:1.1rem;margin-bottom:1rem;">âš™ï¸ ì„¤ì •</div>
      <div style="margin-bottom:1rem;">
        <div style="font-weight:bold;margin-bottom:0.5rem;">ğŸ“Œ í•˜ë£¨ ëª©í‘œ</div>
        ${goalsHtml}
      </div>
    `);
  } catch(e) {
    console.error('showSettings error:', e);
  }
}

function changeDailyGoal(goalId) {
  try {
    if (window.setDailyGoal) window.setDailyGoal(goalId);
    closeXpPopup();
    updateXpHeader();
  } catch(e) {
    console.error('changeDailyGoal error:', e);
  }
}

function showXpPopup(content) {
  const existing = document.getElementById('xpPopup');
  if (existing) existing.remove();
  
  const popup = document.createElement('div');
  popup.id = 'xpPopup';
  popup.innerHTML = `
    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;" onclick="closeXpPopup()">
      <div style="background:white;border-radius:1rem;padding:1.5rem;max-width:350px;width:90%;max-height:80vh;overflow-y:auto;" onclick="event.stopPropagation()">
        ${content}
        <button onclick="closeXpPopup()" style="width:100%;margin-top:1rem;padding:0.75rem;background:#667eea;color:white;border:none;border-radius:0.5rem;cursor:pointer;">ë‹«ê¸°</button>
      </div>
    </div>
  `;
  document.body.appendChild(popup);
}

function closeXpPopup() {
  document.getElementById('xpPopup')?.remove();
}

// ì´ˆê¸° ë¡œë“œ
updateXpHeader();
renderCards();
</script>

<!-- Firebase ë™ê¸°í™” -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAgphZ8FIOMY6vMhcUbg8ZvqkpxxZ_untI",
  authDomain: "jp-tutor-7a967.firebaseapp.com",
  projectId: "jp-tutor-7a967",
  storageBucket: "jp-tutor-7a967.firebasestorage.app",
  messagingSenderId: "937449734884",
  appId: "1:937449734884:web:7827046017d4496363a2f1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

function updateLoginUI(user) {
  const area = document.getElementById('loginArea');
  if (user) {
    area.innerHTML = `
      <div class="dropdown">
        <button class="user-info" onclick="document.getElementById('userDropdown').classList.toggle('show')">
          <img src="${user.photoURL || ''}" class="user-avatar" onerror="this.style.display='none'">
          <span class="user-name">${user.displayName?.split(' ')[0] || ''}</span>
          <span class="sync-icon">âœ“</span>
        </button>
        <div class="dropdown-menu" id="userDropdown">
          <div class="dropdown-item" onclick="window.cloudSave()">â˜ï¸ í•™ìŠµ ì €ì¥</div>
          <div class="dropdown-item" onclick="window.cloudLoad()">ğŸ“¥ í•™ìŠµ ë¶ˆëŸ¬ì˜¤ê¸°</div>
          <div class="dropdown-divider"></div>
          <div class="dropdown-item" onclick="window.handleLogout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</div>
        </div>
      </div>
    `;
  } else {
    area.innerHTML = `<button class="login-btn" onclick="window.handleLogin()">ğŸ” ë¡œê·¸ì¸</button>`;
  }
}

window.handleLogin = async () => {
  try {
    const result = await signInWithPopup(auth, provider);
    const docSnap = await getDoc(doc(db, 'users', result.user.uid));
    if (docSnap.exists()) {
      const cloudData = docSnap.data().data;
      for (const [key, value] of Object.entries(cloudData)) localStorage.setItem(key, value);
      location.reload();
    }
  } catch (e) { alert('ë¡œê·¸ì¸ ì‹¤íŒ¨'); }
};

window.handleLogout = async () => {
  await signOut(auth);
  document.getElementById('userDropdown')?.classList.remove('show');
  updateLoginUI(null);
};

window.cloudSave = async () => {
  document.getElementById('userDropdown')?.classList.remove('show');
  const user = auth.currentUser;
  if (!user) return;
  
  if (confirm('í˜„ì¬ ê¸°ê¸°ì˜ í•™ìŠµ ë°ì´í„°ë¥¼ í´ë¼ìš°ë“œì— ì €ì¥í• ê¹Œìš”?\n(ê¸°ì¡´ í´ë¼ìš°ë“œ ë°ì´í„°ëŠ” ë®ì–´ì“°ê¸°ë©ë‹ˆë‹¤)')) {
    const allData = {};
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      allData[key] = localStorage.getItem(key);
    }
    await setDoc(doc(db, 'users', user.uid), { data: allData, updatedAt: new Date().toISOString() });
    alert('â˜ï¸ í´ë¼ìš°ë“œì— ì €ì¥ ì™„ë£Œ!');
  }
};

window.cloudLoad = async () => {
  document.getElementById('userDropdown')?.classList.remove('show');
  const user = auth.currentUser;
  if (!user) return;
  
  if (confirm('í´ë¼ìš°ë“œì˜ í•™ìŠµ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ê¹Œìš”?\n(í˜„ì¬ ê¸°ê¸° ë°ì´í„°ëŠ” ì‚­ì œë©ë‹ˆë‹¤)')) {
    const docSnap = await getDoc(doc(db, 'users', user.uid));
    if (docSnap.exists()) {
      const cloudData = docSnap.data().data;
      for (const [key, value] of Object.entries(cloudData)) localStorage.setItem(key, value);
      location.reload();
    } else {
      alert('í´ë¼ìš°ë“œì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
  }
};

onAuthStateChanged(auth, (user) => {
  updateLoginUI(user);
  // ì €ì¥ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
  const saveBtn = document.getElementById('cloudSaveBtn');
  if (saveBtn) saveBtn.style.display = user ? 'inline-block' : 'none';
});

// í•˜ë‹¨ ì €ì¥ ë²„íŠ¼ìš©
window.saveToCloud = async () => {
  const user = auth.currentUser;
  if (!user) {
    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }
  if (currentProfile === 'ê²ŒìŠ¤íŠ¸') {
    alert('âš ï¸ ê²ŒìŠ¤íŠ¸ í”„ë¡œí•„ì€ í´ë¼ìš°ë“œì— ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nìƒˆ í”„ë¡œí•„ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.');
    return;
  }
  if (!navigator.onLine) {
    alert('âš ï¸ ë„¤íŠ¸ì›Œí¬ê°€ ì—°ê²°ë˜ì–´ìˆì§€ ì•Šì•„ í´ë¼ìš°ë“œ ì €ì¥ì´ ì–´ë µìŠµë‹ˆë‹¤.\níƒ€ ê¸°ê¸°ì—ì„œ í˜„ì¬ í•™ìŠµìƒí™©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  try {
    const allData = {};
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      allData[key] = localStorage.getItem(key);
    }
    await setDoc(doc(db, 'users', user.uid), { data: allData, updatedAt: new Date().toISOString() });
    localStorage.setItem('lastCloudSave', new Date().toISOString());
    
    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
    const toast = document.createElement('div');
    toast.textContent = 'â˜ï¸ í´ë¼ìš°ë“œì— ì €ì¥ ì™„ë£Œ!';
    toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#4CAF50;color:white;padding:12px 24px;border-radius:25px;z-index:9999;font-size:14px;';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
  } catch (e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
};

document.addEventListener('click', (e) => {
  if (!e.target.closest('.dropdown')) document.getElementById('userDropdown')?.classList.remove('show');
});

// ìë™ ì €ì¥
let saveTimeout = null;
window.autoSaveToCloud = () => {
  const user = auth.currentUser;
  if (!user) return;
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(async () => {
    const allData = {};
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      allData[key] = localStorage.getItem(key);
    }
    await setDoc(doc(db, 'users', user.uid), { data: allData, updatedAt: new Date().toISOString() });
  }, 3000);
};
</script>

<nav class="bottom-nav">
  <div class="bottom-nav-inner">
    <a href="index.html" class="nav-btn"><span>ğŸ </span><span>í™ˆ</span></a>
    <a href="jlpt.html?level=n5" class="nav-btn"><span>ğŸŸ¢</span><span>N5</span></a>
    <a href="jlpt.html?level=n4" class="nav-btn"><span>ğŸŸ </span><span>N4</span></a>
    <a href="notebook.html" class="nav-btn active"><span>ğŸ“–</span><span>ë‹¨ì–´ì¥</span></a>
  </div>
</nav>
</body>
</html>
