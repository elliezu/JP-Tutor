<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‚˜ì˜ ë‹¨ì–´ì¥ - JP Tutor</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Noto Sans JP', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 800px; margin: 0 auto; }
.header { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.header h1 { color: #667eea; font-size: 1.8em; margin-bottom: 10px; }
.nav-links { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
.nav-links a { padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9em; }
.nav-links a:hover { background: #5a6fd6; }
.date-selector { background: white; border-radius: 15px; padding: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; justify-content: center; }
.date-selector input { padding: 10px; border: 2px solid #667eea; border-radius: 10px; font-size: 1em; }
.date-selector button { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; }
.stats { background: white; border-radius: 15px; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-around; text-align: center; }
.stat-item { }
.stat-num { font-size: 1.5em; color: #667eea; font-weight: bold; }
.stat-label { font-size: 0.8em; color: #666; }
.cards-container { display: flex; flex-direction: column; gap: 15px; }
.card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.card-type { font-size: 0.75em; padding: 4px 10px; border-radius: 10px; color: white; }
.card-type.vocab { background: #4CAF50; }
.card-type.kanji { background: #FF9800; }
.card-type.grammar { background: #2196F3; }
.card-type.conv { background: #9C27B0; }
.card-delete { background: #ff4757; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em; }
.card-main { font-size: 1.8em; color: #333; margin-bottom: 5px; }
.card-reading { font-size: 1em; color: #667eea; margin-bottom: 5px; }
.card-meaning { font-size: 1em; color: #666; margin-bottom: 10px; }
.card-example { background: #f8f9fa; padding: 10px; border-radius: 10px; margin-bottom: 15px; }
.card-example-jp { font-size: 1.1em; color: #333; }
.card-example-kr { font-size: 0.9em; color: #666; }
.speak-btn { background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
.practice-area { border-top: 2px dashed #ddd; padding-top: 15px; margin-top: 15px; }
.practice-title { font-size: 0.9em; color: #666; margin-bottom: 10px; }
.practice-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
.practice-box { border: 2px solid #ddd; border-radius: 10px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; position: relative; }
.practice-box input { width: 100%; height: 100%; border: none; text-align: center; font-size: 1.5em; background: transparent; font-family: 'Noto Sans JP', sans-serif; }
.practice-box .guide { position: absolute; font-size: 2em; color: #eee; pointer-events: none; z-index: 0; }
.practice-box input:focus { outline: 2px solid #667eea; }
.practice-box.correct { border-color: #4CAF50; background: #e8f5e9; }
.practice-box.wrong { border-color: #f44336; background: #ffebee; }
.quiz-section { background: white; border-radius: 15px; padding: 20px; margin-top: 20px; text-align: center; }
.quiz-btn { padding: 15px 40px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 25px; font-size: 1.1em; cursor: pointer; }
.quiz-btn:hover { transform: scale(1.05); }
.empty-state { background: white; border-radius: 15px; padding: 40px; text-align: center; color: #666; }
.empty-state h3 { margin-bottom: 10px; color: #333; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
.modal.show { display: flex; }
.modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; }
.modal h3 { margin-bottom: 20px; color: #333; }
.quiz-question { font-size: 1.5em; margin-bottom: 20px; }
.quiz-options { display: flex; flex-direction: column; gap: 10px; }
.quiz-option { padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; text-align: left; }
.quiz-option:hover { border-color: #667eea; }
.quiz-option.correct { background: #4CAF50; color: white; border-color: #4CAF50; }
.quiz-option.wrong { background: #f44336; color: white; border-color: #f44336; }
.quiz-result { text-align: center; padding: 20px; }
.quiz-score { font-size: 2em; color: #667eea; }
.modal-close { margin-top: 20px; padding: 10px 30px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ“– ë‚˜ì˜ ë‹¨ì–´ì¥</h1>
    <div class="nav-links">
      <a href="index.html">ğŸ  ê°€ë‚˜</a>
      <a href="jlpt.html">ğŸ“š JLPT</a>
      <a href="conv.html">ğŸ’¬ íšŒí™”</a>
    </div>
  </div>
  
  <div class="date-selector">
    <label>ë‚ ì§œ ì„ íƒ:</label>
    <input type="date" id="dateInput">
    <button onclick="loadDate()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button onclick="loadAllDates()">ì „ì²´ ë³´ê¸°</button>
  </div>
  
  <div class="stats">
    <div class="stat-item"><div class="stat-num" id="totalCount">0</div><div class="stat-label">ì´ ë‹¨ì–´</div></div>
    <div class="stat-item"><div class="stat-num" id="todayCount">0</div><div class="stat-label">ì˜¤ëŠ˜ ì¶”ê°€</div></div>
    <div class="stat-item"><div class="stat-num" id="practicedCount">0</div><div class="stat-label">ì—°ìŠµ ì™„ë£Œ</div></div>
  </div>
  
  <div class="cards-container" id="cardsContainer"></div>
  
  <div class="quiz-section" id="quizSection" style="display:none;">
    <h3>ì˜¤ëŠ˜ í•™ìŠµí•œ ë‚´ìš©ìœ¼ë¡œ í€´ì¦ˆ!</h3>
    <button class="quiz-btn" onclick="startQuiz()">ğŸ¯ í€´ì¦ˆ ì‹œì‘</button>
  </div>
</div>

<div class="modal" id="quizModal">
  <div class="modal-content" id="quizContent"></div>
</div>

<script>
// í”„ë¡œí•„ ì‹œìŠ¤í…œ
let currentProfile = localStorage.getItem('currentProfile') || 'ê¸°ë³¸';
function getStorageKey(key) { return 'notebook_' + currentProfile + '_' + key; }

// ë‚ ì§œ í¬ë§·
function getToday() {
  const d = new Date();
  return d.toISOString().split('T')[0];
}

// ë‹¨ì–´ì¥ ë°ì´í„° ë¡œë“œ
function getNotebook() {
  return JSON.parse(localStorage.getItem(getStorageKey('data')) || '{}');
}

function saveNotebook(data) {
  localStorage.setItem(getStorageKey('data'), JSON.stringify(data));
}

// ì´ˆê¸°í™”
document.getElementById('dateInput').value = getToday();
let currentViewDate = getToday();
let viewAll = false;

function loadDate() {
  currentViewDate = document.getElementById('dateInput').value;
  viewAll = false;
  renderCards();
}

function loadAllDates() {
  viewAll = true;
  renderCards();
}

// TTS
function speak(text, rate = 0.8) {
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'ja-JP';
  u.rate = rate;
  speechSynthesis.speak(u);
}

// ì¹´ë“œ ì‚­ì œ
function deleteCard(date, index) {
  if (!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
  const nb = getNotebook();
  if (nb[date]) {
    nb[date].splice(index, 1);
    if (nb[date].length === 0) delete nb[date];
    saveNotebook(nb);
    renderCards();
  }
}

// ì—°ìŠµ ì²´í¬
function checkPractice(input, answer, boxEl) {
  const val = input.value.trim();
  if (val === '') {
    boxEl.classList.remove('correct', 'wrong');
    return;
  }
  if (val === answer) {
    boxEl.classList.add('correct');
    boxEl.classList.remove('wrong');
  } else {
    boxEl.classList.add('wrong');
    boxEl.classList.remove('correct');
  }
}

// ì¹´ë“œ ë Œë”ë§
function renderCards() {
  const nb = getNotebook();
  const container = document.getElementById('cardsContainer');
  const today = getToday();
  
  let cards = [];
  let todayCards = [];
  
  if (viewAll) {
    // ì „ì²´ ë‚ ì§œ
    Object.keys(nb).sort().reverse().forEach(date => {
      nb[date].forEach((card, idx) => {
        cards.push({...card, date, idx});
        if (date === today) todayCards.push(card);
      });
    });
  } else {
    // íŠ¹ì • ë‚ ì§œ
    if (nb[currentViewDate]) {
      nb[currentViewDate].forEach((card, idx) => {
        cards.push({...card, date: currentViewDate, idx});
      });
    }
    if (currentViewDate === today) todayCards = cards;
  }
  
  // í†µê³„
  let total = 0;
  Object.values(nb).forEach(arr => total += arr.length);
  document.getElementById('totalCount').textContent = total;
  document.getElementById('todayCount').textContent = nb[today]?.length || 0;
  
  // í€´ì¦ˆ ì„¹ì…˜
  document.getElementById('quizSection').style.display = todayCards.length >= 3 ? 'block' : 'none';
  
  if (cards.length === 0) {
    container.innerHTML = '<div class="empty-state"><h3>ğŸ“ ì•„ì§ ë‹¨ì–´ê°€ ì—†ì–´ìš”</h3><p>JLPTë‚˜ íšŒí™” í˜ì´ì§€ì—ì„œ ì¹´ë“œë¥¼ ë”ë¸”í´ë¦­í•´ì„œ ì¶”ê°€í•´ë³´ì„¸ìš”!</p></div>';
    return;
  }
  
  container.innerHTML = cards.map((card, i) => renderCard(card, i)).join('');
}

function renderCard(card, i) {
  const typeLabel = {vocab:'ì–´íœ˜', kanji:'í•œì', grammar:'ë¬¸ë²•', conv:'íšŒí™”'}[card.type] || 'ê¸°íƒ€';
  const typeClass = card.type || 'vocab';
  
  // ì—°ìŠµí•  ê¸€ì (ì¼ë³¸ì–´ ì²« ê¸€ì ë˜ëŠ” ì „ì²´)
  const practiceText = card.main?.charAt(0) || card.jp?.charAt(0) || '';
  
  let html = `<div class="card">
    <div class="card-header">
      <span class="card-type ${typeClass}">${typeLabel}</span>
      <div>
        <span style="color:#999;font-size:0.8em;">${card.date}</span>
        <button class="card-delete" onclick="deleteCard('${card.date}', ${card.idx})">ì‚­ì œ</button>
      </div>
    </div>`;
  
  // íƒ€ì…ë³„ ë‚´ìš©
  if (card.type === 'kanji') {
    html += `<div class="card-main">${card.kanji} <button class="speak-btn" onclick="speak('${card.reading}')">ğŸ”Š</button></div>
      <div class="card-reading">${card.reading} (${card.onyomi || ''} / ${card.kunyomi || ''})</div>
      <div class="card-meaning">${card.meaning}</div>`;
    if (card.example) {
      html += `<div class="card-example">
        <div class="card-example-jp">${card.example} <button class="speak-btn" onclick="speak('${card.example}')">ğŸ”Š</button></div>
      </div>`;
    }
  } else if (card.type === 'grammar') {
    html += `<div class="card-main">${card.pattern} <button class="speak-btn" onclick="speak('${card.pattern}')">ğŸ”Š</button></div>
      <div class="card-meaning">${card.meaning}</div>
      <div class="card-reading">${card.desc || ''}</div>`;
    if (card.examples?.length) {
      html += card.examples.map(ex => `<div class="card-example">
        <div class="card-example-jp">${ex.jp} <button class="speak-btn" onclick="speak('${ex.jp}')">ğŸ”Š</button></div>
        <div class="card-example-kr">${ex.kr}</div>
      </div>`).join('');
    }
  } else {
    // vocab, conv
    html += `<div class="card-main">${card.jp || card.main} <button class="speak-btn" onclick="speak('${card.jp || card.main}')">ğŸ”Š</button></div>`;
    if (card.reading) html += `<div class="card-reading">${card.reading}</div>`;
    html += `<div class="card-meaning">${card.kr || card.meaning}</div>`;
  }
  
  // ë”°ë¼ì“°ê¸° ì˜ì—­
  html += `<div class="practice-area">
    <div class="practice-title">âœï¸ ë”°ë¼ì“°ê¸° ì—°ìŠµ (5íšŒ)</div>
    <div class="practice-grid">
      ${[0,1,2,3,4].map(n => `<div class="practice-box" id="box_${i}_${n}">
        <span class="guide">${practiceText}</span>
        <input type="text" maxlength="10" oninput="checkPractice(this, '${practiceText}', document.getElementById('box_${i}_${n}'))">
      </div>`).join('')}
    </div>
  </div>`;
  
  html += '</div>';
  return html;
}

// í€´ì¦ˆ
let quizData = [];
let quizIndex = 0;
let quizScore = 0;

function startQuiz() {
  const nb = getNotebook();
  const today = getToday();
  const todayCards = nb[today] || [];
  
  if (todayCards.length < 3) {
    alert('í€´ì¦ˆë¥¼ í•˜ë ¤ë©´ ìµœì†Œ 3ê°œ ì´ìƒì˜ ë‹¨ì–´ê°€ í•„ìš”í•´ìš”!');
    return;
  }
  
  // ì…”í”Œ ë° 10ê°œ ì„ íƒ
  quizData = shuffle([...todayCards]).slice(0, Math.min(10, todayCards.length));
  quizIndex = 0;
  quizScore = 0;
  
  document.getElementById('quizModal').classList.add('show');
  showQuizQuestion();
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function showQuizQuestion() {
  const content = document.getElementById('quizContent');
  
  if (quizIndex >= quizData.length) {
    // ê²°ê³¼
    content.innerHTML = `<div class="quiz-result">
      <h3>í€´ì¦ˆ ì™„ë£Œ!</h3>
      <div class="quiz-score">${quizScore} / ${quizData.length}</div>
      <p>${quizScore === quizData.length ? 'ğŸ‰ ì™„ë²½í•´ìš”!' : quizScore >= quizData.length/2 ? 'ğŸ‘ ì˜í–ˆì–´ìš”!' : 'ğŸ’ª ë‹¤ì‹œ ë³µìŠµí•´ë´ìš”!'}</p>
      <button class="modal-close" onclick="closeQuiz()">ë‹«ê¸°</button>
    </div>`;
    return;
  }
  
  const q = quizData[quizIndex];
  const nb = getNotebook();
  const allCards = [];
  Object.values(nb).forEach(arr => allCards.push(...arr));
  
  // ë¬¸ì œì™€ ì„ íƒì§€
  const question = q.jp || q.kanji || q.pattern || q.main;
  const answer = q.kr || q.meaning;
  
  // ì˜¤ë‹µ ìƒì„±
  let wrongs = allCards.filter(c => (c.kr || c.meaning) !== answer).map(c => c.kr || c.meaning);
  wrongs = shuffle([...new Set(wrongs)]).slice(0, 3);
  
  const options = shuffle([answer, ...wrongs]);
  
  content.innerHTML = `
    <h3>ë¬¸ì œ ${quizIndex + 1} / ${quizData.length}</h3>
    <div class="quiz-question">${question}</div>
    <div class="quiz-options">
      ${options.map((opt, i) => `<div class="quiz-option" onclick="selectAnswer(this, '${opt.replace(/'/g, "\\'")}', '${answer.replace(/'/g, "\\'")}')">${opt}</div>`).join('')}
    </div>
  `;
}

function selectAnswer(el, selected, correct) {
  const options = document.querySelectorAll('.quiz-option');
  options.forEach(o => o.style.pointerEvents = 'none');
  
  if (selected === correct) {
    el.classList.add('correct');
    quizScore++;
  } else {
    el.classList.add('wrong');
    options.forEach(o => {
      if (o.textContent === correct) o.classList.add('correct');
    });
  }
  
  setTimeout(() => {
    quizIndex++;
    showQuizQuestion();
  }, 1000);
}

function closeQuiz() {
  document.getElementById('quizModal').classList.remove('show');
}

// ì´ˆê¸° ë¡œë“œ
renderCards();
</script>
</body>
</html>
